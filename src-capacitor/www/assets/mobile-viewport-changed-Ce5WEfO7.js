import{c8 as A,c9 as k,ca as S,bR as B,cb as K,v as j,cc as G,cd as T,ce as Y,bX as g,cf as q,cg as ee,ch as te,h as O,r as b,d as ne,by as oe,ci as se,a1 as ie,z as I,o as y,A as v,F as P,L as re,B as C,G as U,P as ae,$ as W,D as z,E as Q,aQ as ce,cj as de,ck as le,cl as ue,cm as pe,cn as ge,co as fe,e as me,aM as J,bz as he,cp as _e,cq as we,cr as ye,cs as N,bE as ve,ct as X,Z as Ce,cu as be,cv as Ee,cw as Se,cx as Pe,cy as xe,cz as Ve,cA as ke,cB as De,cC as Oe,cD as Ie,cE as We,cF as Be,cG as Le,cH as Te,w as L,aT as Z,cI as Me,cJ as Re,m as He,b6 as Fe}from"./index-CzwKTze0.js";function $e(o,t,n,e){return n>=o&&n<=t||o>=n&&o<=e}class M{constructor(t,n,e){this.inlineWidgets=t,this.readonly=n,this.getRootNode=e}static init(t,n,e){return new M(t,n,e)}buildDecorations(t){const n=this.getRootNode(),e=[],s=[],i=t.state.selection.main.head,[r,c]=[t.visibleRanges[0].from,t.visibleRanges[t.visibleRanges.length-1].to];return B(n,l=>{if(l.start>c)return!0;if(l.start<r)return;const a=this.inlineWidgets[l.type],d=a?.satisfied&&!a?.satisfied?.(l);if(!a||d)return;const[m,_]=a.showRangeOffset??[0,0];if(t.hasFocus&&!a.ignoreEditing&&i>=l.start-m&&i<=l.end+_)return;const f=K.init(t,l,a,this.getRootNode,this.readonly);f&&s.push(f)}),[S.set(e),S.set(s)]}}const Ge=(o,t,n)=>A.fromClass(class{commonDecorations;atomicDecorations;decorationPlugin;lastPosition;constructor(e){this.decorationPlugin=M.init(t,n,o),this.initDecorations(e)}initDecorations(e){[this.commonDecorations,this.atomicDecorations]=this.decorationPlugin.buildDecorations(e)}update(e){const s=e.state.selection.main.head,i=this.lastPosition!==s;this.lastPosition=s,(e.docChanged||e.viewportChanged||e.focusChanged||i)&&this.initDecorations(e.view)}},{decorations:e=>e.atomicDecorations,provide:e=>k.atomicRanges.of(s=>s.plugin(e)?.atomicDecorations||S.none)}),ze=o=>{const t=document.querySelector(".cm-activeLine");if(!t)return;const n=typeof o=="string"?document.querySelector(o):o;if(!n)return;const e=j(()=>parseInt(window.getComputedStyle(n).paddingTop))(),s=30,i=24,r=G(t,"padding-top"),l=G(t,"line-height")/2-i/2,a=t.getBoundingClientRect().top+r*1.1+l+n.scrollTop-e,d=document.createElement("div");return d.className="cm-action-menu",d.style.position="absolute",d.style.top=`${a}px`,d.style.zIndex="5",d.style.height=`${s}`,document.querySelector(".cm-editor").appendChild(d),d},Ne=o=>{let t,n,e;return k.updateListener.of(s=>{const i=s.state.doc.lineAt(s.state.selection.main.head);!(i.number!==t)&&!s.geometryChanged||(t=i.number,e?.destroy(),n?.remove(),n=ze(o.parentElement),n&&(e=o.menuRenderer(n,s.view)))})};function Ae(o){return T.transactionFilter.of(t=>{if(t.docChanged&&t.annotation(Y.userEvent)){let n=!1;const e=[],s=o();if(B(s,i=>{if(i.is(g.PropertyDrawer)&&i.parent?.is(g.Root))return e[0]=i.start,e[1]=i.end+1,!0}),t.changes.iterChangedRanges((i,r)=>{i>=e[0]&&r<=e[1]&&i!==r&&(n=!0)}),n)return[]}return t})}const je=(o,t)=>A.fromClass(class{decorations=S.none;lastPosition;constructor(){this.initDecorations()}initDecorations(){const n=o(),e=[];B(n,s=>{const i=t[s.type]?.class;if(!i)return!1;const r=typeof i=="function"?i(s):i;r&&(this.applyLineDecorationsForSrcParentBLock(e,s,r),e.push(S.line({class:r}).range(s.start,s.start)))}),e.sort((s,i)=>s.from-i.from),this.decorations=S.set(e)}applyLineDecorationsForSrcParentBLock(n,e,s){if(!q(e,l=>l.is(g.SrcBlock)))return;const r=e.value?.split(`
`);let c=e.start;r?.forEach(l=>{const a=S.line({class:s}).range(c,c);c+=l.length+1,n.push(a)})}update(n){const e=n.state.selection.main.head,s=this.lastPosition!==e;(n.docChanged||n.viewportChanged||s)&&this.initDecorations()}},{decorations:n=>n.decorations}),qe=(o,t,n,e)=>{let s;return k.updateListener.of(i=>{const r=o(),c=i.state.selection.main.head,l=c!==s;if(s=c,!i.docChanged&&!i.viewportChanged&&!l)return;const a=[];B(r,d=>{if(!t[d.type])return!1;const m=i.changedRanges.find(u=>$e(u.fromA,u.toA,d.start,d.end+1)),_=c>=d.start&&c<=d.end+1;if(!n&&(m||_)){a.push(ee.of(d));return}const f=t[d.type];!f.suppressEdit&&f.satisfied&&!f.satisfied(d)||a.push(te.of({orgNode:d,view:i.view,rootNodeSrc:o,multilineWidget:f,editBadgeWidget:e}))}),i.view.dispatch({effects:a})})},Ue=O({__name:"SearchContainer",props:{items:{},autofocus:{type:Boolean},handlerWrapper:{type:Function}},setup(o,{expose:t}){t();const n=o,e=b(""),s=ne(()=>n.items.filter(c=>!e.value||c.command.includes(e.value.trim().toLowerCase())||c.description?.toLowerCase().includes(e.value.trim().toLowerCase()))),r={props:n,search:e,filteredItems:s,handleItem:c=>{n.handlerWrapper?n.handlerWrapper(c.handler)():c.handler()},get extractDynamicValue(){return oe},HeaderBar:se,SearchInput:ie};return Object.defineProperty(r,"__isScriptSetup",{enumerable:!1,value:!0}),r}}),Qe={class:"search-container"},Je={class:"text-capitalize"},Xe={class:"items"},Ze=["onClick"],Ke={class:"icon"},Ye={class:"title text-capitalize"},et={key:0,class:"description text-capitalize"};function tt(o,t,n,e,s,i){return y(),v("div",Qe,[P(e.HeaderBar,null,{header:re(()=>[C("div",Je,[P(e.SearchInput,{modelValue:e.search,"onUpdate:modelValue":t[0]||(t[0]=r=>e.search=r),autofocus:n.autofocus},null,8,["modelValue","autofocus"])])]),_:1}),C("div",Xe,[(y(!0),v(U,null,ae(e.filteredItems,r=>(y(),v("div",{class:"search-container-item",key:r.command,onClick:c=>e.handleItem(r)},[C("div",Ke,[P(W,{size:"md",name:e.extractDynamicValue(r.icon)},null,8,["name"])]),C("div",Ye,z(o.$t(r.command)),1),r.description?(y(),v("div",et,z(o.$t(r.description)),1)):Q("",!0)],8,Ze))),128))])])}const nt=I(Ue,[["render",tt],["__scopeId","data-v-141c52db"],["__file","SearchContainer.vue"]]),ot=O({__name:"EditorMenu",props:{editorView:{}},setup(o,{expose:t}){t();const n=o,e=b(),s=()=>{e.value=!0},i=ce(),r=i.getCommandsFromGroup("editor"),l={props:n,dialogOpened:e,openEditorInsertDialog:s,commandsStore:i,editorInsertItems:r,onItemClicked:a=>()=>a({editorView:n.editorView}),SearchContainer:nt};return Object.defineProperty(l,"__isScriptSetup",{enumerable:!1,value:!0}),l}}),st={class:"cm-editor-actions"},it={role:"button",class:"cm-editor-menu"},rt={key:0,class:"editor-dialog"};function at(o,t,n,e,s,i){return y(),v(U,null,[C("div",st,[C("div",it,[P(W,{name:"drag_indicator",size:"sm"})]),C("div",{onClick:e.openEditorInsertDialog,role:"button",class:"cm-editor-menu"},[P(W,{name:"add_box",size:"sm"})])]),e.dialogOpened?(y(),v("div",rt,[P(e.SearchContainer,{autofocus:!0,items:e.editorInsertItems,"handler-wrapper":e.onItemClicked,resetable:!0},null,8,["items"])])):Q("",!0)],64)}const ct=I(ot,[["render",at],["__scopeId","data-v-8957303f"],["__file","EditorMenu.vue"]]);function dt(o){const t=[de,le(),ue(),pe(),Ae(o.orgNodeGetter),ge,Ne({parentElement:".q-page",menuRenderer:(s,i)=>o.dynamicComponent.mount(ct,s,{editorView:i})}),k.lineWrapping,T.readOnly.of(o.readonly),fe.of([{key:"Escape",run:()=>(o.editorViewGetter()?.contentDOM.blur(),!1)}])],n=o.showSpecialSymbols?[]:[Ge(o.orgNodeGetter,o.inlineEmbeddedWidgets,o.readonly),qe(o.orgNodeGetter,o.multilineEmbeddedWidgets,o.readonly,o.editBadgeWidget),je(o.orgNodeGetter,o.lineClasses)],e=o.extensions.map(s=>s({orgNodeGetter:o.orgNodeGetter,readonly:o.readonly,showSpecialSymbols:o.showSpecialSymbols,dynamicComponent:o.dynamicComponent,editorViewGetter:o.editorViewGetter,foldWidget:o.foldWidget}));return[...t,...n,...o.additionalExtensions??[],...e]}const lt=O({__name:"GutterMarker",props:{open:{type:Boolean},disabled:{type:Boolean}},setup(o,{expose:t}){t();const n={};return Object.defineProperty(n,"__isScriptSetup",{enumerable:!1,value:!0}),n}});function ut(o,t,n,e,s,i){return y(),me(W,{name:"expand_more",size:"sm",class:J(["text-bold fold-gutter",{closed:!n.open,disabled:n.disabled}])},null,8,["class"])}const pt=I(lt,[["render",ut],["__scopeId","data-v-9f344438"],["__file","GutterMarker.vue"]]),gt=O({__name:"OrgHeadlineOperator",props:{node:{},editorView:{}},setup(o,{expose:t}){t();const n=o,e=he(n,"node"),s=()=>{const u=[],h=_e(n.editorView.state).iter();for(;h.value;)u.push([h.from,h.to]),h.next();return u},i=s(),r=()=>e.value.parent.end-1,c=e.value.parent?.parent?.section?.children?.length,l=r(),a=b(!i.find(([u])=>u===l)),d=()=>{const u=q(e.value,w=>w.is(g.Root)),h=e.value.parent.parent.end===u.end?0:1,E=r(),x=e.value.parent.parent.end-h;return[E,x]},m=()=>we(e.value.parent?.parent?.section,u=>u.is(g.Headline)),f={props:n,node:e,getFoldedRanges:s,ranges:i,getFromFolding:r,sectionExist:c,from:l,opened:a,getFoldingRange:d,getFirstNestedHeadline:m,toggleFolding:()=>{if(!c)return;const[u,h]=d(),E=m();if(a.value=!a.value,!a.value){n.editorView.dispatch({effects:ye.of({from:u,to:h})});return}const x={from:u,to:h},w=[N.of(x)];if(E){const D={from:u,to:E.start-1};w.push(N.of(D))}n.editorView.dispatch({effects:w})},GutterMarker:pt};return Object.defineProperty(f,"__isScriptSetup",{enumerable:!1,value:!0}),f}});function ft(o,t,n,e,s,i){return y(),v("span",{onClick:ve(e.toggleFolding,["stop","prevent"]),class:"headline-fold"},[P(e.GutterMarker,{open:e.opened,disabled:!e.sectionExist},null,8,["open","disabled"])])}const mt=I(gt,[["render",ft],["__scopeId","data-v-0a39dbc6"],["__file","OrgHeadlineOperator.vue"]]),ht=()=>{const{createWidgetBuilder:o,dynamicComponent:t,multilineExtensions:n,inlineExtensions:e,lineClassesExtensions:s}=X(),i=n,r=e,c=s,a=((m,_={})=>(f,u={})=>t.mount(m,f,{..._,...u}))(Ce,{icon:"edit_note",activeIcon:"done"}),d={decorationType:"replace",ignoreEvent:!0,widgetBuilder:o(mt)};return{createWidgetBuilder:o,multilineEmbeddedWidgets:i,inlineEmbeddedWidgets:r,lineClasses:c,foldWidget:d,editBadgeWidget:a}};class _t extends Ve{constructor(t){super(),this.config=t}createParse(t){const n=t.read(0,t.length),e=ke(De(n));return this.config?.orgAstChanged?.(e),{advance:()=>this.convertOrgModeTreeToCmTree(e,n),parsedPos:t.length,stopAt:()=>{},stoppedAt:t.length}}convertOrgModeTreeToCmTree(t,n){const e=[];t.title&&e.push(t.title),t.section&&e.push(t.section);const s=t.children??e,i=this.tryParseNestedCodeBlock(n,t);if(i)return i;const r=this.getCmNodeNameByOrgNode(t);return new Oe(Ie.define({id:We(r),name:r,top:t.is(g.Root),props:[Be,Le,Te]}),s?.map(c=>this.convertOrgModeTreeToCmTree(c,n))??[],s?.map(c=>c.start-t.start),t.length)}getCmNodeNameByOrgNode(t){return t.is(g.Title)&&t.parent?.is(g.Headline)?`Headline-${t.parent.level}`:t.is(g.Operator)&&t.parent?.parent?.is(g.ListItem)&&t?.parent.isNot(g.Section)&&(t.value==="- "||t.value==="+ ")?"ListBullet":t.is(g.Text)&&t.parent?.is(g.TagList)?"FileTag":t.type}tryParseNestedCodeBlock(t,n){if(!n.is(g.BlockBody)||!n.parent.is(g.SrcBlock,g.HtmlBlock))return;const e=n.parent.properties.language?.toLowerCase(),s=n.parent.is(g.HtmlBlock)?"html":null,i=this.config?.wrap?.[e??s??"c"];return i?i.parse(t.slice(n.start,n.end)):void 0}}function wt(o){const t=Se(),n=new _t(o);return new Pe(t,n,[],"org-mode")}function yt(o){return new be(wt(o),[Ee(xe)])}const vt=O({__name:"RawEditor",props:{modelValue:{default:()=>""},readonly:{type:Boolean},config:{}},emits:["update:modelValue","dataUpdated","changeCursorPosition","focusChanged","init"],setup(o,{expose:t,emit:n}){t();const e=o,s=n,i=b(e.modelValue);let r;const c=p=>{e.readonly||(i.value=p,s("dataUpdated",[p,r]))},l=b();let a;const{multilineEmbeddedWidgets:d,inlineEmbeddedWidgets:m,lineClasses:_,foldWidget:f,editBadgeWidget:u}=ht(),h=Me(),E=()=>{if(!a)return;const p=a.state.doc.lineAt(a.state.doc.length);a.dispatch({selection:{anchor:p.to,head:p.to}})},{extensions:x}=X(),w=()=>{if(!e.modelValue)return;a?.destroy();const p=T.create({doc:e.modelValue,extensions:[yt({orgAstChanged:V=>{r=V},wrap:Re}),k.updateListener.of(V=>{V.docChanged&&c(V.state.doc.toString()),s("changeCursorPosition",V.state.selection.main.head),R(V.view.hasFocus)}),dt({dynamicComponent:h,editorViewGetter:()=>a,inlineEmbeddedWidgets:m,lineClasses:_,multilineEmbeddedWidgets:d,readonly:e.readonly,extensions:x,orgNodeGetter:()=>r,showSpecialSymbols:e.config?.showSpecialSymbols,foldWidget:f,editBadgeWidget:u})]});a=new k({state:p,parent:l.value}),s("init",{view:a}),E()},D=b(!1),R=p=>{D.value!==p&&(D.value=p,s("focusChanged",p))},{keyboardOpened:H}=Et();L(()=>H.value,p=>{if(p){setTimeout(()=>F(),100);return}a.contentDOM.blur()});const F=j(()=>{window.scroll(0,-1),a.dispatch({selection:{anchor:a.state.selection.main.head,head:a.state.selection.main.head},scrollIntoView:!0})});Z(()=>w()),L(()=>e.modelValue,p=>{!l.value||p===a?.state.doc.toString()||w()}),L(()=>[e.readonly,e.config],()=>{a&&w()},{deep:!0});const $={props:e,emits:s,text:i,get orgNode(){return r},set orgNode(p){r=p},setText:c,editor:l,get editorView(){return a},set editorView(p){a=p},multilineEmbeddedWidgets:d,inlineEmbeddedWidgets:m,lineClasses:_,foldWidget:f,editBadgeWidget:u,dynamicComponent:h,setCursorPositionToTheEOF:E,extensions:x,initEditor:w,focus:D,changeFocus:R,keyboardOpened:H,scrollIntoCurrentLine:F};return Object.defineProperty($,"__isScriptSetup",{enumerable:!1,value:!0}),$}}),Ct={id:"editor",ref:"editor"};function bt(o,t,n,e,s,i){return y(),v("div",{class:J(["editor-wrapper center-container",{readonly:n.readonly,"hide-special-symbols":!e.props.config?.showSpecialSymbols,"show-property-drawer":n.config?.showPropertyDrawer}])},[C("div",Ct,null,512)],2)}const Pt=I(vt,[["render",bt],["__file","RawEditor.vue"]]);function Et(o){const t=He(),n=t.platform.is.electron?32:0,e=b(window.innerHeight-n),s=b(!1),i={viewportHeight:e,keyboardOpened:s};if(!t.platform.is.mobile||!window.visualViewport)return i;const r=()=>{s.value=Math.round(window.innerHeight)!==Math.round(window.visualViewport.height)||window.innerHeight/window.screen.availHeight<=.6,e.value=window.visualViewport.height-n,o?.(i)};return Z(()=>window.visualViewport.addEventListener("resize",r)),Fe(()=>window.visualViewport.removeEventListener("resize",r)),i}export{Pt as R,Et as o};
