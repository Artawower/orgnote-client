var ee=Object.defineProperty;var te=(o,t,n)=>t in o?ee(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n;var x=(o,t,n)=>(te(o,typeof t!="symbol"?t+"":t,n),n);import{bP as q,bQ as V,bR as k,bv as H,bS as ne,v as U,bT as A,bU as $,bV as oe,bC as f,bW as Q,bX as se,bY as ie,h as T,r as S,d as re,b5 as ae,bZ as ce,bs as de,z as R,o as w,A as C,F as O,a2 as le,B as E,G as X,a3 as ue,ab as M,D as N,E as Y,af as pe,b_ as fe,b$ as ge,c0 as me,c1 as he,c2 as _e,c3 as ve,e as ye,a7 as Z,b6 as we,c4 as be,c5 as Ce,c6 as Ee,c7 as j,bc as Se,c8 as J,a1 as Pe,c9 as xe,ca as ke,cb as Oe,cc as De,cd as Ie,ce as Ve,cf as Be,cg as Le,ch as Te,ci as Re,cj as We,ck as Me,cl as He,cm as Fe,w as F,ai as K,cn as $e,co as Ge,m as ze,aA as Ae}from"./index-CHdFPrnc.js";function Ne(o,t,n,e){return n>=o&&n<=t||o>=n&&o<=e}class G{constructor(t,n,e){this.inlineWidgets=t,this.readonly=n,this.getRootNode=e}static init(t,n,e){return new G(t,n,e)}buildDecorations(t){const n=this.getRootNode(),e=[],i=[],s=t.state.selection.main.head,[r,c]=[t.visibleRanges[0].from,t.visibleRanges[t.visibleRanges.length-1].to];return H(n,d=>{var h,b;if(d.start>c)return!0;if(d.start<r)return;const a=this.inlineWidgets[d.type],l=(a==null?void 0:a.satisfied)&&!((h=a==null?void 0:a.satisfied)!=null&&h.call(a,d));if(!a||l)return;const[_,v]=(b=a.showRangeOffset)!=null?b:[0,0];if(t.hasFocus&&!a.ignoreEditing&&s>=d.start-_&&s<=d.end+v)return;const m=ne.init(t,d,a,this.getRootNode,this.readonly);m&&i.push(m)}),[k.set(e),k.set(i)]}}const je=(o,t,n)=>q.fromClass(class{constructor(e){x(this,"commonDecorations");x(this,"atomicDecorations");x(this,"decorationPlugin");x(this,"lastPosition");this.decorationPlugin=G.init(t,n,o),this.initDecorations(e)}initDecorations(e){[this.commonDecorations,this.atomicDecorations]=this.decorationPlugin.buildDecorations(e)}update(e){const i=e.state.selection.main.head,s=this.lastPosition!==i;this.lastPosition=i,(e.docChanged||e.viewportChanged||e.focusChanged||s)&&this.initDecorations(e.view)}},{decorations:e=>e.atomicDecorations,provide:e=>V.atomicRanges.of(i=>{var s;return((s=i.plugin(e))==null?void 0:s.atomicDecorations)||k.none})}),qe=o=>{const t=document.querySelector(".cm-activeLine");if(!t)return;const n=typeof o=="string"?document.querySelector(o):o;if(!n)return;const e=U(()=>parseInt(window.getComputedStyle(n).paddingTop))(),i=30,s=24,r=A(t,"padding-top"),d=A(t,"line-height")/2-s/2,a=t.getBoundingClientRect().top+r*1.1+d+n.scrollTop-e,l=document.createElement("div");return l.className="cm-action-menu",l.style.position="absolute",l.style.top=`${a}px`,l.style.zIndex="5",l.style.height=`${i}`,document.querySelector(".cm-editor").appendChild(l),l},Ue=o=>{let t,n,e;return V.updateListener.of(i=>{const s=i.state.doc.lineAt(i.state.selection.main.head);!(s.number!==t)&&!i.geometryChanged||(t=s.number,e==null||e.destroy(),n==null||n.remove(),n=qe(o.parentElement),n&&(e=o.menuRenderer(n,i.view)))})};function Qe(o){return $.transactionFilter.of(t=>{if(t.docChanged&&t.annotation(oe.userEvent)){let n=!1;const e=[],i=o();if(H(i,s=>{var r;if(s.is(f.PropertyDrawer)&&((r=s.parent)!=null&&r.is(f.Root)))return e[0]=s.start,e[1]=s.end+1,!0}),t.changes.iterChangedRanges((s,r)=>{s>=e[0]&&r<=e[1]&&s!==r&&(n=!0)}),n)return[]}return t})}const Xe=(o,t)=>q.fromClass(class{constructor(){x(this,"decorations",k.none);x(this,"lastPosition");this.initDecorations()}initDecorations(){const n=o(),e=[];H(n,i=>{var c;const s=(c=t[i.type])==null?void 0:c.class;if(!s)return!1;const r=typeof s=="function"?s(i):s;r&&(this.applyLineDecorationsForSrcParentBLock(e,i,r),e.push(k.line({class:r}).range(i.start,i.start)))}),e.sort((i,s)=>i.from-s.from),this.decorations=k.set(e)}applyLineDecorationsForSrcParentBLock(n,e,i){var d;if(!Q(e,a=>a.is(f.SrcBlock)))return;const r=(d=e.value)==null?void 0:d.split(`
`);let c=e.start;r==null||r.forEach(a=>{const l=k.line({class:i}).range(c,c);c+=a.length+1,n.push(l)})}update(n){const e=n.state.selection.main.head,i=this.lastPosition!==e;(n.docChanged||n.viewportChanged||i)&&this.initDecorations()}},{decorations:n=>n.decorations}),Ye=(o,t,n,e)=>{let i;return V.updateListener.of(s=>{const r=o(),c=s.state.selection.main.head,d=c!==i;if(i=c,!s.docChanged&&!s.viewportChanged&&!d)return;const a=[];H(r,l=>{if(!t[l.type])return!1;const _=s.changedRanges.find(h=>Ne(h.fromA,h.toA,l.start,l.end+1)),v=c>=l.start&&c<=l.end+1;if(!n&&(_||v)){a.push(se.of(l));return}const m=t[l.type];!m.suppressEdit&&m.satisfied&&!m.satisfied(l)||a.push(ie.of({orgNode:l,view:s.view,rootNodeSrc:o,multilineWidget:m,editBadgeWidget:e}))}),s.view.dispatch({effects:a})})},Ze=T({__name:"SearchContainer",props:{items:{},autofocus:{type:Boolean},handlerWrapper:{type:Function}},setup(o,{expose:t}){t();const n=o,e=S(""),i=re(()=>n.items.filter(c=>{var d;return!e.value||c.command.includes(e.value.trim().toLowerCase())||((d=c.description)==null?void 0:d.toLowerCase().includes(e.value.trim().toLowerCase()))})),r={props:n,search:e,filteredItems:i,handleItem:c=>{n.handlerWrapper?n.handlerWrapper(c.handler)():c.handler()},get extractDynamicValue(){return ae},HeaderBar:ce,SearchInput:de};return Object.defineProperty(r,"__isScriptSetup",{enumerable:!1,value:!0}),r}}),Je={class:"search-container"},Ke={class:"text-capitalize"},et={class:"items"},tt=["onClick"],nt={class:"icon"},ot={class:"title text-capitalize"},st={key:0,class:"description text-capitalize"};function it(o,t,n,e,i,s){return w(),C("div",Je,[O(e.HeaderBar,null,{header:le(()=>[E("div",Ke,[O(e.SearchInput,{modelValue:e.search,"onUpdate:modelValue":t[0]||(t[0]=r=>e.search=r),autofocus:n.autofocus},null,8,["modelValue","autofocus"])])]),_:1}),E("div",et,[(w(!0),C(X,null,ue(e.filteredItems,r=>(w(),C("div",{class:"search-container-item",key:r.command,onClick:c=>e.handleItem(r)},[E("div",nt,[O(M,{size:"md",name:e.extractDynamicValue(r.icon)},null,8,["name"])]),E("div",ot,N(o.$t(r.command)),1),r.description?(w(),C("div",st,N(o.$t(r.description)),1)):Y("",!0)],8,tt))),128))])])}const rt=R(Ze,[["render",it],["__scopeId","data-v-141c52db"],["__file","SearchContainer.vue"]]),at=T({__name:"EditorMenu",props:{editorView:{}},setup(o,{expose:t}){t();const n=o,e=S(),i=()=>{e.value=!0},s=pe(),r=s.getCommandsFromGroup("editor"),d={props:n,dialogOpened:e,openEditorInsertDialog:i,commandsStore:s,editorInsertItems:r,onItemClicked:a=>()=>a({editorView:n.editorView}),SearchContainer:rt};return Object.defineProperty(d,"__isScriptSetup",{enumerable:!1,value:!0}),d}}),ct={class:"cm-editor-actions"},dt={role:"button",class:"cm-editor-menu"},lt={key:0,class:"editor-dialog"};function ut(o,t,n,e,i,s){return w(),C(X,null,[E("div",ct,[E("div",dt,[O(M,{name:"drag_indicator",size:"sm"})]),E("div",{onClick:e.openEditorInsertDialog,role:"button",class:"cm-editor-menu"},[O(M,{name:"add_box",size:"sm"})])]),e.dialogOpened?(w(),C("div",lt,[O(e.SearchContainer,{autofocus:!0,items:e.editorInsertItems,"handler-wrapper":e.onItemClicked,resetable:!0},null,8,["items"])])):Y("",!0)],64)}const pt=R(at,[["render",ut],["__scopeId","data-v-8957303f"],["__file","EditorMenu.vue"]]);function ft(o){var i;const t=[fe,ge(),me(),he(),Qe(o.orgNodeGetter),_e,Ue({parentElement:".q-page",menuRenderer:(s,r)=>o.dynamicComponent.mount(pt,s,{editorView:r})}),V.lineWrapping,$.readOnly.of(o.readonly),ve.of([{key:"Escape",run:()=>{var s;return(s=o.editorViewGetter())==null||s.contentDOM.blur(),!1}}])],n=o.showSpecialSymbols?[]:[je(o.orgNodeGetter,o.inlineEmbeddedWidgets,o.readonly),Ye(o.orgNodeGetter,o.multilineEmbeddedWidgets,o.readonly,o.editBadgeWidget),Xe(o.orgNodeGetter,o.lineClasses)],e=o.extensions.map(s=>s({orgNodeGetter:o.orgNodeGetter,readonly:o.readonly,showSpecialSymbols:o.showSpecialSymbols,dynamicComponent:o.dynamicComponent,editorViewGetter:o.editorViewGetter,foldWidget:o.foldWidget}));return[...t,...n,...(i=o.additionalExtensions)!=null?i:[],...e]}const gt=T({__name:"GutterMarker",props:{open:{type:Boolean},disabled:{type:Boolean}},setup(o,{expose:t}){t();const n={};return Object.defineProperty(n,"__isScriptSetup",{enumerable:!1,value:!0}),n}});function mt(o,t,n,e,i,s){return w(),ye(M,{name:"expand_more",size:"sm",class:Z(["text-bold fold-gutter",{closed:!n.open,disabled:n.disabled}])},null,8,["class"])}const ht=R(gt,[["render",mt],["__scopeId","data-v-9f344438"],["__file","GutterMarker.vue"]]),_t=T({__name:"OrgHeadlineOperator",props:{node:{},editorView:{}},setup(o,{expose:t}){var h,b,B,L;t();const n=o,e=we(n,"node"),i=()=>{const p=[],g=be(n.editorView.state).iter();for(;g.value;)p.push([g.from,g.to]),g.next();return p},s=i(),r=()=>e.value.parent.end-1,c=(L=(B=(b=(h=e.value.parent)==null?void 0:h.parent)==null?void 0:b.section)==null?void 0:B.children)==null?void 0:L.length,d=r(),a=S(!s.find(([p])=>p===d)),l=()=>{const p=Q(e.value,P=>P.is(f.Root)),g=e.value.parent.parent.end===p.end?0:1,y=r(),D=e.value.parent.parent.end-g;return[y,D]},_=()=>{var p,g;return Ce((g=(p=e.value.parent)==null?void 0:p.parent)==null?void 0:g.section,y=>y.is(f.Headline))},m={props:n,node:e,getFoldedRanges:i,ranges:s,getFromFolding:r,sectionExist:c,from:d,opened:a,getFoldingRange:l,getFirstNestedHeadline:_,toggleFolding:()=>{if(!c)return;const[p,g]=l(),y=_();if(a.value=!a.value,!a.value){n.editorView.dispatch({effects:Ee.of({from:p,to:g})});return}const D={from:p,to:g},P=[j.of(D)];if(y){const W={from:p,to:y.start-1};P.push(j.of(W))}n.editorView.dispatch({effects:P})},GutterMarker:ht};return Object.defineProperty(m,"__isScriptSetup",{enumerable:!1,value:!0}),m}});function vt(o,t,n,e,i,s){return w(),C("span",{onClick:Se(e.toggleFolding,["stop","prevent"]),class:"headline-fold"},[O(e.GutterMarker,{open:e.opened,disabled:!e.sectionExist},null,8,["open","disabled"])])}const yt=R(_t,[["render",vt],["__scopeId","data-v-2e549ea3"],["__file","OrgHeadlineOperator.vue"]]),wt=()=>{const{createWidgetBuilder:o,dynamicComponent:t,multilineExtensions:n,inlineExtensions:e,lineClassesExtensions:i}=J(),s=n,r=e,c=i,a=((_,v={})=>(m,h={})=>t.mount(_,m,{...v,...h}))(Pe,{icon:"edit_note",activeIcon:"done"}),l={decorationType:"replace",ignoreEvent:!0,widgetBuilder:o(yt)};return{createWidgetBuilder:o,multilineEmbeddedWidgets:s,inlineEmbeddedWidgets:r,lineClasses:c,foldWidget:l,editBadgeWidget:a}};class bt extends Ve{constructor(t){super(),this.config=t}createParse(t){var i,s;const n=t.read(0,t.length),e=Be(Le(n));return(s=(i=this.config)==null?void 0:i.orgAstChanged)==null||s.call(i,e),{advance:()=>this.convertOrgModeTreeToCmTree(e,n),parsedPos:t.length,stopAt:()=>{},stoppedAt:t.length}}convertOrgModeTreeToCmTree(t,n){var c,d;const e=[];t.title&&e.push(t.title),t.section&&e.push(t.section);const i=(c=t.children)!=null?c:e,s=this.tryParseNestedCodeBlock(n,t);if(s)return s;const r=this.getCmNodeNameByOrgNode(t);return new Te(Re.define({id:We(r),name:r,top:t.is(f.Root),props:[Me,He,Fe]}),(d=i==null?void 0:i.map(a=>this.convertOrgModeTreeToCmTree(a,n)))!=null?d:[],i==null?void 0:i.map(a=>a.start-t.start),t.length)}getCmNodeNameByOrgNode(t){var n,e,i,s;return t.is(f.Title)&&((n=t.parent)!=null&&n.is(f.Headline))?`Headline-${t.parent.level}`:t.is(f.Operator)&&((i=(e=t.parent)==null?void 0:e.parent)!=null&&i.is(f.ListItem))&&(t!=null&&t.parent.isNot(f.Section))&&(t.value==="- "||t.value==="+ ")?"ListBullet":t.is(f.Text)&&((s=t.parent)!=null&&s.is(f.TagList))?"FileTag":t.type}tryParseNestedCodeBlock(t,n){var c,d,a,l;if(!n.is(f.BlockBody)||!n.parent.is(f.SrcBlock,f.HtmlBlock))return;const e=(c=n.parent.properties.language)==null?void 0:c.toLowerCase(),i=n.parent.is(f.HtmlBlock)?"html":null,s=(l=(d=this.config)==null?void 0:d.wrap)==null?void 0:l[(a=e!=null?e:i)!=null?a:"c"];return s?s.parse(t.slice(n.start,n.end)):void 0}}function Ct(o){const t=Oe(),n=new bt(o);return new De(t,n,[],"org-mode")}function Et(o){return new xe(Ct(o),[ke(Ie)])}const St=T({__name:"RawEditor",props:{modelValue:{default:()=>""},readonly:{type:Boolean},config:{}},emits:["update:modelValue","dataUpdated","changeCursorPosition","focusChanged","init"],setup(o,{expose:t,emit:n}){t();const e=o,i=n,s=S(e.modelValue);let r;const c=u=>{e.readonly||(s.value=u,i("dataUpdated",[u,r]))},d=S();let a;const{multilineEmbeddedWidgets:l,inlineEmbeddedWidgets:_,lineClasses:v,foldWidget:m,editBadgeWidget:h}=wt(),b=$e(),B=()=>{if(!a)return;const u=a.state.doc.lineAt(a.state.doc.length);a.dispatch({selection:{anchor:u.to,head:u.to}})},{extensions:L}=J(),p=()=>{var z;if(!e.modelValue)return;a==null||a.destroy();const u=$.create({doc:e.modelValue,extensions:[Et({orgAstChanged:I=>{r=I},wrap:Ge}),V.updateListener.of(I=>{I.docChanged&&c(I.state.doc.toString()),i("changeCursorPosition",I.state.selection.main.head),y(I.view.hasFocus)}),ft({dynamicComponent:b,editorViewGetter:()=>a,inlineEmbeddedWidgets:_,lineClasses:v,multilineEmbeddedWidgets:l,readonly:e.readonly,extensions:L,orgNodeGetter:()=>r,showSpecialSymbols:(z=e.config)==null?void 0:z.showSpecialSymbols,foldWidget:m,editBadgeWidget:h})]});a=new V({state:u,parent:d.value}),i("init",{view:a}),B()},g=S(!1),y=u=>{g.value!==u&&(g.value=u,i("focusChanged",u))},{keyboardOpened:D}=kt();F(()=>D.value,u=>{if(u){setTimeout(()=>P(),100);return}a.contentDOM.blur()});const P=U(()=>{window.scroll(0,-1),a.dispatch({selection:{anchor:a.state.selection.main.head,head:a.state.selection.main.head},scrollIntoView:!0})});K(()=>p()),F(()=>e.modelValue,u=>{!d.value||u===(a==null?void 0:a.state.doc.toString())||p()}),F(()=>[e.readonly,e.config],()=>{a&&p()},{deep:!0});const W={props:e,emits:i,text:s,get orgNode(){return r},set orgNode(u){r=u},setText:c,editor:d,get editorView(){return a},set editorView(u){a=u},multilineEmbeddedWidgets:l,inlineEmbeddedWidgets:_,lineClasses:v,foldWidget:m,editBadgeWidget:h,dynamicComponent:b,setCursorPositionToTheEOF:B,extensions:L,initEditor:p,focus:g,changeFocus:y,keyboardOpened:D,scrollIntoCurrentLine:P};return Object.defineProperty(W,"__isScriptSetup",{enumerable:!1,value:!0}),W}}),Pt={id:"editor",ref:"editor"};function xt(o,t,n,e,i,s){var r,c;return w(),C("div",{class:Z(["editor-wrapper center-container",{readonly:n.readonly,"hide-special-symbols":!((r=e.props.config)!=null&&r.showSpecialSymbols),"show-property-drawer":(c=n.config)==null?void 0:c.showPropertyDrawer}])},[E("div",Pt,null,512)],2)}const It=R(St,[["render",xt],["__file","RawEditor.vue"]]);function kt(o){const t=ze(),n=t.platform.is.electron?32:0,e=S(window.innerHeight-n),i=S(!1),s={viewportHeight:e,keyboardOpened:i};if(!t.platform.is.mobile||!window.visualViewport)return s;const r=()=>{i.value=Math.round(window.innerHeight)!==Math.round(window.visualViewport.height)||window.innerHeight/window.screen.availHeight<=.6,e.value=window.visualViewport.height-n,o==null||o(s)};return K(()=>window.visualViewport.addEventListener("resize",r)),Ae(()=>window.visualViewport.removeEventListener("resize",r)),s}export{It as R,kt as o};
